# Loud and Clear â€” LancerMail staging gateway
# Exim reads patch status from /opt/lancer/state/patch_level and /opt/lancer/state/banner.

primary_hostname = staging.lancer.pccc

# Where Exim stores messages while processing (used by qa_hook via message_id)
spool_directory = /var/spool/exim4

# Logs
log_file_path = /var/log/exim4/%slog

# Listen everywhere (challenge network)
local_interfaces = 0.0.0.0
daemon_smtp_ports = 2525

# Local domains that we accept mail for
domainlist local_domains = staging.lancer.pccc : lancer.pccc : lancercorp.com

# Banner includes the current patch label (runtime-updated by patchd)
smtp_banner = 220 LancerMail ${readfile{/opt/lancer/state/banner}} ESMTP Exim $version_number

# Access Control Lists
acl_smtp_rcpt = acl_check_rcpt
acl_smtp_data = acl_check_data

# --- ACLs ---
begin acl

# Keep RCPT rules simple: allow local domains only.
acl_check_rcpt:
  deny    message = 550 Relaying denied (local domains only)
          domains = ! +local_domains
  accept

# The challenge logic triggers at end of DATA.
# Special recipients:
#   audit@staging.lancer.pccc   -> patch levels 1-4
#   plant@staging.lancer.pccc   -> patch level 5 (stage payload)
#   exec@staging.lancer.pccc    -> patch level 5 (execute staged payload)
#
# We intentionally "deny" these messages with a custom reason string so the
# output is returned to the SMTP client (token leak path).
acl_check_data:

  # --- Patch validation console: audit path ---
  deny  condition = ${if match{$recipients}{(^|[ ,])audit@}{yes}{no}}
        message   = ${run{/usr/bin/python3 /opt/lancer/bin/qa_hook.py audit $message_id}}

  accept

# --- Routers / Transports ---
begin routers

local_router:
  driver = accept
  domains = +local_domains
  transport = local_delivery

begin transports

local_delivery:
  driver = appendfile
  file = /var/mail/${local_part}
  mode = 0600
  user = Debian-exim
  group = mail

begin retry
# Default retry rule (not heavily used in this challenge, but Exim expects a retry section)
*                      *           F,2h,15m; G,16h,1h,1.5; F,4d,6h

begin rewrite

begin authenticators
